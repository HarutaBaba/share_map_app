<h1>ShareMap</h1>
<div id='map'></div>
<%= include_gon %>


<style>
#map{
  height: 700px;
}
</style>

<script>
<% if !@fplan.nil? %>
var map;
var marker;
var infoWindow;
var markerLatLng;
var center = {
  lat: 34.7019399, // 緯度
  lng: 135.51002519999997 // 経度
};
var markerData = {
   		name: '<%= @fplan.name %>',
   		title: '<%= @fplan.title %>',
   		time: '<%= @fplan.time %>',
   		status: '<%= @fplan.status %>',
   		lat: '<%= @fplan.lat %>',
   		lng: '<%= @fplan.lng %>'
 };

 // 地図の作成
 function initMap() {
 	map = new google.maps.Map(document.getElementById('map'), { // #mapに地図を埋め込む
    center: center, // 地図の中心を指定
    zoom: 15 // 地図のズームを指定
   });

 // マーカー毎の処理
        marker = new google.maps.Marker({ // マーカーの追加
         position: new google.maps.LatLng(markerData['lat'], markerData['lng']), // マーカーを立てる位置を指定
         map: map // マーカーを立てる地図を指定
       });

     infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
         content: '<div>' + markerData['name'] + '<br/>' + markerData['title'] + '<br/>' + markerData['time'] + '<br/>' + markerData['status'] + '</div>' // 吹き出しに表示する内容
       });

     markerEvent(); // マーカーにクリックイベントを追加
 }

// マーカーにクリックイベントを追加
function markerEvent() {
    marker.addListener('click', function() { // マーカーをクリックしたとき
      infoWindow.open(map, marker); // 吹き出しの表示
  });
}



<% else %>

var map;
var marker;
var infoWindow;
var center = {
  lat: 34.7019399, // 緯度
  lng: 135.51002519999997 // 経度
};
// 地図を埋め込む
function initMap() {
 map = new google.maps.Map(document.getElementById('map'), { // #mapに地図を埋め込む
     center: center, // 地図の中心を指定
     zoom: 15 // 地図のズームを指定
   });
 
 //mapをクリックしたときのイベントを設定
  google.maps.event.addListener(map, 'click', mylistener);

       //クリックしたときの処理
   function mylistener(event){
        marker = new google.maps.Marker();
        //markerの位置を設定
    	 //event.latLng.lat()でクリックしたところの緯度を取得
    	 marker.setPosition(new google.maps.LatLng(event.latLng.lat(), event.latLng.lng()));
      	//marker設置
    	  marker.setMap(map);
     	 infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
          content: '<div><%= @name %><%= @title %><br/><%= @time %><br/><%= @status %></div>' // 吹き出しに表示する内容
       	});
       	$('.lat').val(event.latLng.lat());
       	$('.lng').val(event.latLng.lng());
     	  markerEvent(); // マーカーにクリックイベントを追加
      }
       
   function markerEvent() {
      marker.addListener('click', function() { // マーカーをクリックしたとき
        infoWindow.open(map, marker); // 吹き出しの表示
      });
   }
   
}

<% end %>

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmSQvPRnvLiANGb7VflD3ZD1R4zWiqYC4&callback=initMap" async defer></script>

</br>

<% if logged_in? %>
  <%= form_for(@userplan, url: {controller: :maps, action: :index}, method: :get) do |f| %>
      <% @followuser.each do |aaa| %>
          <%= f.hidden_field 'followid[]', :value => aaa.id %>
      <% end %>
      <%= f.hidden_field :kari, :value => 'kari' %>
      <% @para = 'a' %>
      <%= f.submit "友達の予定を表示する", class: "btn btn-primary" %>
  <% end %>
<% end %>

<%= form_tag(maps_path, method: :post) do %>
  <%= label_tag(:title, "タイトル")  %>
　<%= text_field_tag "title","" ,class: 'form-control' %>
　<%= label_tag(:time, "日付")  %>
　<%= text_field_tag "time",""  ,class: 'form-control'%>
　<%= label_tag(:status, "募集する")  %>
　<%= radio_button_tag(:status, "募集する") %>
　<%= label_tag(:status, "募集しない") %>
  <%= radio_button_tag(:status, "募集しない") %>
　<%= submit_tag "位置を登録する", class: "btn btn-primary" %>
<% end %>

<% if !@title.nil? %>
 <%= current_user.name %>
 <%= @title %>
 <%= @time %>
 <%= @status %>



 <% @plan = Plan.new unless @plan %>
 <%= form_for(@plan, url: plans_path) do |f| %>
  <%= f.hidden_field :name, :value => current_user.name %>
  <%= f.hidden_field :title, :value => @title %>
  <%= f.hidden_field :time, :value => @time %>
  <%= f.hidden_field :status, :value => @status %>
  <%= f.hidden_field :lat, class:'lat', :value => @lat %>
  <%= f.hidden_field :lng, class:'lng', :value => @lng %>
  <%= f.submit "予定情報を登録する", class: "btn btn-primary" %>
 <% end %>
 
 <% end %>